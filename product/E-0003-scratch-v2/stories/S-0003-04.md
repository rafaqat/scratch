---
id: S-0003-04
title: "MCP database tools"
status: Done
estimate_points: 3
tags: [database, mcp, backend]
owner: "claude"
created_at: "2026-02-13"
started_at: "2026-02-13 21:50"
completed_at: "2026-02-13 22:03"
target_version: ""
commits: []
links:
  epic: E-0003-scratch-v2
  blockedBy: [S-0003-01]
---

[← Roadmap](../README.md) · Databases · **4 of 4**
Blocked by: [S-0003-01 Schema](S-0003-01.md)
Prev: [← S-0003-03](S-0003-03.md) · Next feature: [S-0003-05 Wikilinks →](S-0003-05.md)

---

Expose database operations via MCP so AI agents can work with structured data.

## Acceptance Criteria

- [x] `db_list` — List all databases with schema summaries
- [x] `db_get_schema` — Get full schema for a database
- [x] `db_query` — Query rows with filters, sorting, pagination
- [x] `db_insert_row` — Create a new row with field values
- [x] `db_update_row` — Update specific fields on a row (etag for concurrency)
- [x] `db_delete_row` — Delete a row
- [x] `db_create` — Create a new database with schema definition

## Technical Notes

Follow the existing MCP tool pattern in `src-tauri/src/mcp.rs`. Use the same JSON-RPC dispatch pattern as the stories tools.

## Design Decisions

### Query Filter Syntax
Filters use a structured `{field, operator, value}` triple format rather than a query string DSL. This approach:
- Is self-documenting via the JSON Schema (LLMs can construct filters from the tool description)
- Supports 12 operators: `eq`, `neq`, `gt`, `gte`, `lt`, `lte`, `contains`, `not_contains`, `starts_with`, `ends_with`, `is_empty`, `is_not_empty`
- Handles multiple types: numeric comparison for numbers, string comparison for text/date/select, array membership for multi-select
- Multiple filters are ANDed together (all must match)
- Filters are applied sequentially, which naturally composes

### Concurrency Control (etag)
Reuses the same `compute_etag()` function from the stories module (hash of file contents). The flow:
1. `db_query` returns an `etag` field with each row
2. `db_update_row` requires the etag and checks it before writing
3. On mismatch, returns a `CONFLICT` error instructing the caller to refetch
4. After successful update, the response includes the new etag

This matches the stories_update pattern exactly for consistency.

### Sorting
Sorting uses a `{field, direction}` object. Direction defaults to "asc". The sort comparator handles:
- Numeric values (f64 comparison)
- Boolean values (false < true)
- String values (lexicographic, covers text/date/select/url)
- Missing values sort before present values

## Results

All 7 MCP database tools implemented:

| Tool | Description | Lines in mcp.rs | Lines in lib.rs |
|------|-------------|-----------------|-----------------|
| `db_list` | Scans notes folder for database folders | Tool def + handler | `db_list_impl` |
| `db_get_schema` | Returns full schema with columns, views | Tool def + handler | `db_get_schema_impl` |
| `db_query` | Filters, sorts, paginates rows with etags | Tool def + handler | `db_query_impl` + helpers |
| `db_insert_row` | Creates row with auto-ID | Tool def + handler | `db_insert_row_impl` |
| `db_update_row` | Updates with etag concurrency check | Tool def + handler | `db_update_row_impl` |
| `db_delete_row` | Deletes row file | Tool def + handler | `db_delete_row_impl` |
| `db_create` | Creates database folder + schema | Tool def + handler | `db_create_impl` |

Files modified:
- `src-tauri/src/mcp.rs` — 7 tool definitions in `get_tools()`, 7 dispatch cases, 7 handler functions
- `src-tauri/src/lib.rs` — 7 `_impl` functions + 2 helper functions (`compare_values`, `compare_json_values`)

## Activity Log

| Date | Event | Details |
|------|-------|---------|
| 2026-02-13 | Created | Story added to E-0003 roadmap |
| 2026-02-13 21:50 | Started | Claimed by claude |
| 2026-02-13 22:03 | Completed | All 7 database MCP tools implemented |
