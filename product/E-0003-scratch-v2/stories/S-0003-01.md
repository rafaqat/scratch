---
id: S-0003-01
title: "Database schema & file format"
status: Done
estimate_points: 8
tags: [database, backend, file-format]
owner: "claude"
created_at: "2026-02-13"
started_at: "2026-02-13 21:34"
completed_at: "2026-02-13 21:42"
target_version: ""
commits:
  - a556d40
links:
  epic: E-0003-scratch-v2
  blocks: [S-0003-02, S-0003-03, S-0003-04]
---

[← Roadmap](../Scratch v2 Roadmap.md) · Databases · **1 of 4**
Blocks: [S-0003-02](S-0003-02.md) · [S-0003-03](S-0003-03.md) · [S-0003-04](S-0003-04.md)
Next: [S-0003-02 Table view →](S-0003-02.md)

---

Define the `.db.md` format for markdown-native databases.

## Acceptance Criteria

- [x] Database definition file with YAML frontmatter: columns, types, views
- [x] Column types: text, number, date, select, multi-select, checkbox, relation, url
- [x] Each database = folder with `_schema.md` + row `.md` files
- [x] Row files have frontmatter matching schema + optional markdown body
- [x] Rust backend parses, validates, and CRUDs database rows
- [x] Schema migrations: add/remove/rename columns updates existing rows

## Technical Notes

Generalize `src-tauri/src/stories.rs` kanban pattern into reusable database engine.

```
my-tasks/
  _schema.md       # columns, views, metadata
  row-001.md       # frontmatter fields + markdown body
  row-002.md
```


## Activity Log

| Date | Event | Details |
|------|-------|---------|
| 2026-02-13 | Created | Story added to E-0003 roadmap |
| 2026-02-13 | Started | Implementation begun by claude |
| 2026-02-13 | Design | Schema format: `_schema.md` with YAML frontmatter defining columns array (id, name, type, options), views array, and metadata. Row files: `{slug}.md` with frontmatter matching column names. Column types: text, number, date, select, multi-select, checkbox, relation, url. Auto-incrementing row IDs. Generalizes stories.rs pattern into `src-tauri/src/database.rs`. TypeScript types in `src/types/database.ts`, service in `src/services/database.ts`. |
| 2026-02-13 | Commit | `a556d40` — Rust database module, TypeScript types & service, 12 Tauri commands, 8 unit tests |
| 2026-02-13 | Done | All 6 acceptance criteria met. cargo check passes, tsc passes, all 8 tests pass. |

## Results

### Files Created

| File | Purpose | Lines |
|------|---------|-------|
| `src-tauri/src/database.rs` | Rust database engine: schema parsing, row CRUD, migration | ~1100 |
| `src/types/database.ts` | TypeScript types: ColumnDef, DatabaseSchema, DatabaseRow, etc. | ~110 |
| `src/services/database.ts` | Frontend service layer: Tauri command wrappers for all DB ops | ~116 |

### Files Modified

| File | Changes |
|------|---------|
| `src-tauri/src/lib.rs` | Added `pub mod database;`, 12 Tauri command wrappers, command registration |

### Schema Format (`_schema.md`)

```yaml
---
name: My Tasks
columns:
  - id: title
    name: Title
    type: text
  - id: status
    name: Status
    type: select
    options: [Todo, In Progress, Done]
  - id: priority
    name: Priority
    type: number
  - id: due_date
    name: Due Date
    type: date
  - id: done
    name: Done
    type: checkbox
  - id: tags
    name: Tags
    type: multi-select
    options: [bug, feature, docs]
  - id: website
    name: Website
    type: url
views:
  - id: default-table
    name: All Tasks
    type: table
  - id: status-board
    name: Status Board
    type: board
    group_by: status
next_row_id: 1
---
```

### Row Format (`row-001.md`)

```yaml
---
title: "Buy groceries"
status: "Todo"
priority: 1
due_date: "2026-02-15"
done: false
tags: [feature]
website: ""
---

Optional markdown body here.
```

### Column Types

| Type | Default | YAML Representation |
|------|---------|---------------------|
| text | `""` | `key: "value"` |
| number | `0` | `key: 42` |
| date | `""` | `key: "2026-02-13"` |
| select | `""` | `key: "Option"` |
| multi-select | `[]` | `key: [a, b]` |
| checkbox | `false` | `key: true` |
| relation | `""` | `key: "other-db/row-001"` |
| url | `""` | `key: "https://..."` |

### Tauri Commands (12 total)

| Command | Purpose |
|---------|---------|
| `db_list` | Scan notes folder for all databases |
| `db_create` | Create new database folder with schema |
| `db_get` | Get schema + all rows |
| `db_get_schema` | Get schema only |
| `db_delete` | Delete entire database |
| `db_create_row` | Add row with auto-increment ID |
| `db_update_row` | Update row fields (merge semantics) |
| `db_delete_row` | Delete a row file |
| `db_add_column` | Add column, migrate rows with default |
| `db_remove_column` | Remove column, clean up rows and views |
| `db_rename_column` | Rename column ID/name, update rows and views |
| `db_update_schema` | Full schema replace with migration |

### Tests (8 passing)

- `test_parse_schema` — Full schema parsing with all column types
- `test_parse_row` — Row parsing with frontmatter and body
- `test_serialize_row` — Row serialization back to markdown
- `test_column_type_roundtrip` — All 8 column types serialize/deserialize
- `test_slugify` — Folder name generation
- `test_schema_validation_duplicate_column` — Rejects duplicate column IDs
- `test_schema_validation_select_without_options` — Rejects select without options
- `test_schema_validation_relation_without_target` — Rejects relation without target
